<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management - Rice Products</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .content-section {
            padding-top: 80px;
        }
        .product-image {
            max-width: 200px;
            max-height: 200px;
            object-fit: contain;
        }
        .product-card {
            margin-bottom: 20px;
        }
        .nav-tabs {
            margin-bottom: 20px;
        }
        .feature-list, .spec-list, .cert-list {
            margin-top: 10px;
        }
        .feature-item, .spec-item, .cert-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .weight-option-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .weight-options-list, .nutritional-info {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">Rice Products</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html#home">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="index.html#products">All Products</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="product_management.html">Product Management</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Content Section -->
    <div class="content-section">
        <div class="container mt-5">
            <h1 class="mb-4">Product Manager</h1>
            
            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab">Products</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab">Categories</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="certifications-tab" data-bs-toggle="tab" data-bs-target="#certifications" type="button" role="tab">Certifications</button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="myTabContent">
                <!-- Products Tab -->
                <div class="tab-pane fade show active" id="products" role="tabpanel">
                    <!-- Add Product Form -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Add New Product</h5>
                            <form id="productForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="name" class="form-label">Product Name</label>
                                        <input type="text" class="form-control" id="name" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="categoryId" class="form-label">Category</label>
                                        <select class="form-control" id="categoryId" required>
                                            <!-- Categories will be loaded here -->
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" rows="3"></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label for="pricePerKg" class="form-label">Price per KG</label>
                                        <input type="number" class="form-control" id="pricePerKg" step="0.01" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="inventory" class="form-label">Inventory</label>
                                        <input type="number" class="form-control" id="inventory" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="productImage" class="form-label">Product Image</label>
                                        <input type="file" class="form-control" id="productImage" accept="image/*">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="isNewArrival">
                                            <label class="form-check-label" for="isNewArrival">New Arrival</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="isBestSeller">
                                            <label class="form-check-label" for="isBestSeller">Best Seller</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="hasDiscount">
                                            <label class="form-check-label" for="hasDiscount">Has Discount</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="discountPercentage" class="form-label">Discount %</label>
                                        <input type="number" class="form-control" id="discountPercentage" min="0" max="100">
                                    </div>
                                </div>

                                <!-- Features Section -->
                                <div class="mb-3">
                                    <label class="form-label">Features</label>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="featureInput" placeholder="Add a feature">
                                        <button class="btn btn-outline-secondary" type="button" onclick="addFeature()">Add</button>
                                    </div>
                                    <div id="featuresList" class="feature-list"></div>
                                </div>

                                <!-- Specifications Section -->
                                <div class="mb-3">
                                    <label class="form-label">Specifications</label>
                                    <div class="row mb-2">
                                        <div class="col-md-5">
                                            <input type="text" class="form-control" id="specNameInput" placeholder="Specification name">
                                        </div>
                                        <div class="col-md-5">
                                            <input type="text" class="form-control" id="specValueInput" placeholder="Specification value">
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-outline-secondary w-100" type="button" onclick="addSpecification()">Add</button>
                                        </div>
                                    </div>
                                    <div id="specificationsList" class="spec-list"></div>
                                </div>

                                <!-- Weight Options Section -->
                                <div class="mb-3">
                                    <label class="form-label">Weight Options</label>
                                    <div class="row mb-2">
                                        <div class="col-md-3">
                                            <input type="number" class="form-control" id="weightValueInput" placeholder="Weight in grams">
                                        </div>
                                        <div class="col-md-3">
                                            <input type="number" class="form-control" id="weightPriceInput" step="0.01" placeholder="Price">
                                        </div>
                                        <div class="col-md-4">
                                            <input type="file" class="form-control" id="packagingPhotoInput" accept="image/*">
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-outline-secondary w-100" type="button" onclick="addWeightOption()">Add</button>
                                        </div>
                                    </div>
                                    <div id="weightOptionsList" class="weight-options-list"></div>
                                </div>

                                <!-- Nutritional Info Section -->
                                <div class="mb-3">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="hasNutritionalInfo" onchange="toggleNutritionalInfoForm()">
                                        <label class="form-check-label" for="hasNutritionalInfo">Add Nutritional Information</label>
                                    </div>
                                    
                                    <div id="nutritionalInfoForm" style="display: none;">
                                        <div class="row mb-2">
                                            <div class="col-md-6">
                                                <label for="servingSize" class="form-label">Serving Size</label>
                                                <input type="text" class="form-control" id="servingSize">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="servingsPerContainer" class="form-label">Servings Per Container</label>
                                                <input type="text" class="form-control" id="servingsPerContainer">
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-3 mb-2">
                                                <label for="calories" class="form-label">Calories</label>
                                                <input type="text" class="form-control" id="calories">
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label for="totalFat" class="form-label">Total Fat</label>
                                                <input type="text" class="form-control" id="totalFat">
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label for="saturatedFat" class="form-label">Saturated Fat</label>
                                                <input type="text" class="form-control" id="saturatedFat">
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label for="transFat" class="form-label">Trans Fat</label>
                                                <input type="text" class="form-control" id="transFat">
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-3 mb-2">
                                                <label for="cholesterol" class="form-label">Cholesterol</label>
                                                <input type="text" class="form-control" id="cholesterol">
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label for="sodium" class="form-label">Sodium</label>
                                                <input type="text" class="form-control" id="sodium">
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label for="totalCarbohydrates" class="form-label">Total Carbohydrates</label>
                                                <input type="text" class="form-control" id="totalCarbohydrates">
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label for="dietaryFiber" class="form-label">Dietary Fiber</label>
                                                <input type="text" class="form-control" id="dietaryFiber">
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-3 mb-2">
                                                <label for="sugars" class="form-label">Sugars</label>
                                                <input type="text" class="form-control" id="sugars">
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label for="protein" class="form-label">Protein</label>
                                                <input type="text" class="form-control" id="protein">
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label for="vitaminA" class="form-label">Vitamin A</label>
                                                <input type="text" class="form-control" id="vitaminA">
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <label for="vitaminC" class="form-label">Vitamin C</label>
                                                <input type="text" class="form-control" id="vitaminC">
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-2">
                                                <label for="calcium" class="form-label">Calcium</label>
                                                <input type="text" class="form-control" id="calcium">
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <label for="iron" class="form-label">Iron</label>
                                                <input type="text" class="form-control" id="iron">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Certifications Section -->
                                <div class="mb-3">
                                    <label class="form-label">Certifications</label>
                                    <div class="input-group mb-2">
                                        <select class="form-control" id="certificationSelect">
                                            <!-- Certifications will be loaded here -->
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" onclick="addCertification()">Add</button>
                                    </div>
                                    <div id="selectedProductCertificationsList" class="cert-list"></div>
                                </div>

                                <button type="submit" class="btn btn-primary" id="submitProductBtn">Add Product</button>
                                <button type="button" class="btn btn-secondary ms-2" id="cancelEditBtn" style="display: none;" onclick="resetProductForm()">Cancel Edit</button>
                            </form>
                        </div>
                    </div>

                    <!-- Products List -->
                    <div id="productsList" class="row"></div>
                </div>

                <!-- Categories Tab -->
                <div class="tab-pane fade" id="categories" role="tabpanel">
                    <!-- Add Category Form -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Add New Category</h5>
                            <form id="categoryForm">
                                <div class="mb-3">
                                    <label for="categoryName" class="form-label">Category Name</label>
                                    <input type="text" class="form-control" id="categoryName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="categoryDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Category</button>
                            </form>
                        </div>
                    </div>

                    <!-- Categories List -->
                    <div id="categoriesList" class="row"></div>
                </div>

                <!-- Certifications Tab -->
                <div class="tab-pane fade" id="certifications" role="tabpanel">
                    <!-- Add Certification Form -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">Add New Certification</h5>
                            <form id="certificationForm">
                                <div class="mb-3">
                                    <label for="certificationName" class="form-label">Certification Name</label>
                                    <input type="text" class="form-control" id="certificationName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="certificationDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="certificationDescription" rows="3"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Certification</button>
                            </form>
                        </div>
                    </div>

                    <!-- Certifications List -->
                    <div id="allCertificationsDisplayList" class="row"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:8080/api';
        const BACKEND_URL = 'http://localhost:8080';

        // Helper function to fetch with authentication token
        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('token');
            const headers = {
                ...(options.headers || {}),
            };

            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            // Special handling for FormData: fetch adds Content-Type automatically
            if (!(options.body instanceof FormData)) {
                // Default to JSON content type if not specified and body exists
                if (!headers['Content-Type'] && options.body) {
                    headers['Content-Type'] = 'application/json';
                }
            } else {
                // Remove Content-Type header if body is FormData, let the browser set it
                delete headers['Content-Type'];
            }

            const response = await fetch(url, {
                ...options,
                headers: headers
            });

            if (response.status === 401) {
                // Unauthorized: redirect to login or show message
                console.error('Authentication required. Redirecting to login.');
                // window.location.href = '/login.html'; // Optional: redirect
                throw new Error('Authentication failed. Please log in again.');
            }

            return response;
        }

        // Arrays to store temporary data
        let features = [];
        let specifications = [];
        let certifications = [];
        let weightOptions = [];
        let hasNutritionalInfo = false;
        let editingProductId = null; // To track if we are editing

        // Load all products
        async function loadProducts() {
            try {
                // Use fetchWithAuth for the initial products list
                const response = await fetchWithAuth(`${API_URL}/products`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to load products');
                }
                const products = await response.json();
                if (!Array.isArray(products)) {
                    throw new Error('Invalid response format: products is not an array');
                }
                const productsList = document.getElementById('productsList');
                productsList.innerHTML = '';

                for (const product of products) {
                    try {
                        // Use fetchWithAuth for all subsequent detail fetches
                        const [featuresResponse, specificationsResponse, certificationsResponse, 
                              nutritionalInfoResponse, weightOptionsResponse] = await Promise.all([
                            fetchWithAuth(`${API_URL}/products/${product.id}/features`),
                            fetchWithAuth(`${API_URL}/products/${product.id}/specifications`),
                            fetchWithAuth(`${API_URL}/products/${product.id}/certifications`),
                            fetchWithAuth(`${API_URL}/products/${product.id}/nutritional-info`),
                            fetchWithAuth(`${API_URL}/products/${product.id}/weight-options`)
                        ]);
                        
                        const features = await featuresResponse.json();
                        const specifications = await specificationsResponse.json();
                        const certifications = await certificationsResponse.json();
                        
                        let nutritionalInfo = null;
                        if (nutritionalInfoResponse.ok) {
                            nutritionalInfo = await nutritionalInfoResponse.json();
                        }
                        
                        const weightOptions = await weightOptionsResponse.json();
                        
                        // Create product card with all details
                        const productCard = document.createElement('div');
                        productCard.className = 'col-md-4';
                        
                        // Create feature HTML
                        let featuresHtml = '';
                        if (features && features.length > 0) {
                            featuresHtml = `
                                <div class="mt-3">
                                    <h6>Features:</h6>
                                    <ul class="list-group">
                                        ${features.map(feature => 
                                            `<li class="list-group-item">${feature.feature}</li>`
                                        ).join('')}
                                    </ul>
                                </div>
                            `;
                        }
                        
                        // Create specifications HTML
                        let specificationsHtml = '';
                        if (specifications && specifications.length > 0) {
                            specificationsHtml = `
                                <div class="mt-3">
                                    <h6>Specifications:</h6>
                                    <ul class="list-group">
                                        ${specifications.map(spec => 
                                            `<li class="list-group-item"><strong>${spec.specName}:</strong> ${spec.specValue}</li>`
                                        ).join('')}
                                    </ul>
                                </div>
                            `;
                        }
                        
                        // Create certifications HTML
                        let certificationsHtml = '';
                        if (certifications && certifications.length > 0) {
                            certificationsHtml = `
                                <div class="mt-3">
                                    <h6>Certifications:</h6>
                                    <div>
                                        ${certifications.map(cert => 
                                            `<span class="badge bg-info me-1">${cert.name}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Create weight options HTML
                        let weightOptionsHtml = '';
                        if (weightOptions && weightOptions.length > 0) {
                            weightOptionsHtml = `
                                <div class="mt-3">
                                    <h6>Weight Options:</h6>
                                    <div class="row">
                                        ${weightOptions.map(option => {
                                            return `
                                            <div class="col-md-6 mb-2">
                                                <div class="card">
                                                    ${option.packagingPhoto ? 
                                                        `<img src="${BACKEND_URL}${option.packagingPhoto}" class="card-img-top" style="max-height: 100px; object-fit: contain;" alt="Packaging">` : 
                                                        ''}
                                                    <div class="card-body">
                                                        <p class="card-text">
                                                            <strong>Weight:</strong> ${option.weightValue}g<br>
                                                            <strong>Price:</strong> $${option.price}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Create nutritional info HTML
                        let nutritionalInfoHtml = '';
                        if (nutritionalInfo) {
                            nutritionalInfoHtml = `
                                <div class="mt-3">
                                    <h6>Nutritional Information:</h6>
                                    <div class="card">
                                        <div class="card-body">
                                            <p class="mb-1"><strong>Serving Size:</strong> ${nutritionalInfo.servingSize || 'N/A'}</p>
                                            <p class="mb-1"><strong>Servings Per Container:</strong> ${nutritionalInfo.servingsPerContainer || 'N/A'}</p>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <p class="mb-1"><strong>Calories:</strong> ${nutritionalInfo.calories || 'N/A'}</p>
                                                    <p class="mb-1"><strong>Total Fat:</strong> ${nutritionalInfo.totalFat || 'N/A'}</p>
                                                    <p class="mb-1"><strong>Saturated Fat:</strong> ${nutritionalInfo.saturatedFat || 'N/A'}</p>
                                                    <p class="mb-1"><strong>Trans Fat:</strong> ${nutritionalInfo.transFat || 'N/A'}</p>
                                                    <p class="mb-1"><strong>Cholesterol:</strong> ${nutritionalInfo.cholesterol || 'N/A'}</p>
                                                    <p class="mb-1"><strong>Sodium:</strong> ${nutritionalInfo.sodium || 'N/A'}</p>
                                                    <p class="mb-1"><strong>Total Carbohydrates:</strong> ${nutritionalInfo.totalCarbohydrates || 'N/A'}</p>
                                                    <p class="mb-1"><strong>Dietary Fiber:</strong> ${nutritionalInfo.dietaryFiber || 'N/A'}</p>
                                                </div>
                                                <div class="col-md-6">
                                                    <p class="mb-1"><strong>Sugars:</strong> ${nutritionalInfo.sugars || 'N/A'}</p>
                                                    <p class="mb-1"><strong>Protein:</strong> ${nutritionalInfo.protein || 'N/A'}</p>
                                                    <p class="mb-1"><strong>Vitamin A:</strong> ${nutritionalInfo.vitaminA || 'N/A'}</p>
                                                    <p class="mb-1"><strong>Vitamin C:</strong> ${nutritionalInfo.vitaminC || 'N/A'}</p>
                                                    <p class="mb-1"><strong>Calcium:</strong> ${nutritionalInfo.calcium || 'N/A'}</p>
                                                    <p class="mb-1"><strong>Iron:</strong> ${nutritionalInfo.iron || 'N/A'}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        productCard.innerHTML = `
                            <div class="card product-card">
                                <img src="${BACKEND_URL}/api/products/${product.id}/image" class="card-img-top product-image" alt="${product.name}">
                                <div class="card-body">
                                    <h5 class="card-title">${product.name}</h5>
                                    <p class="card-text">${product.description || ''}</p>
                                    <p class="card-text">
                                        <strong>Price:</strong> $${product.pricePerKg}/kg<br>
                                        <strong>Inventory:</strong> ${product.inventory}<br>
                                        ${product.hasDiscount ? `<strong>Discount:</strong> ${product.discountPercentage}%<br>` : ''}
                                        ${product.isNewArrival ? '<span class="badge bg-success">New Arrival</span> ' : ''}
                                        ${product.isBestSeller ? '<span class="badge bg-warning">Best Seller</span>' : ''}
                                    </p>
                                    ${featuresHtml}
                                    ${specificationsHtml}
                                    ${certificationsHtml}
                                    ${weightOptionsHtml}
                                    ${nutritionalInfoHtml}
                                    <div class="mt-3">
                                        <button class="btn btn-danger btn-sm me-2" onclick="deleteProduct(${product.id})">Delete</button>
                                        <button class="btn btn-secondary btn-sm" onclick="startEditProduct(${product.id})">Edit</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        productsList.appendChild(productCard);
                    } catch (error) {
                        console.error(`Error loading details for product ${product.id}:`, error);
                    }
                }
            } catch (error) {
                console.error('Error loading products:', error);
                const productsList = document.getElementById('productsList');
                productsList.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger" role="alert">
                            Error loading products: ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        // Load all categories
        async function loadCategories() {
            try {
                // Use fetchWithAuth
                const response = await fetchWithAuth(`${API_URL}/categories`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const categories = await response.json();
                const categoriesList = document.getElementById('categoriesList');
                const categorySelect = document.getElementById('categoryId');
                
                // Update categories list
                categoriesList.innerHTML = '';
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                
                categories.forEach(category => {
                    // Add to select dropdown
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);

                    // Add to categories list
                    const categoryCard = document.createElement('div');
                    categoryCard.className = 'col-md-4 mb-3';
                    categoryCard.innerHTML = `
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">${category.name}</h5>
                                <p class="card-text">${category.description || ''}</p>
                                <button class="btn btn-danger" onclick="deleteCategory(${category.id})">Delete</button>
                            </div>
                        </div>
                    `;
                    categoriesList.appendChild(categoryCard);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
                alert('Error loading categories: ' + error.message);
            }
        }

        // Load all certifications
        async function loadCertifications() {
            try {
                // Use fetchWithAuth
                const response = await fetchWithAuth(`${API_URL}/certifications`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const allCerts = await response.json();
                const allCertificationsDisplay = document.getElementById('allCertificationsDisplayList');
                const certificationSelectDropdown = document.getElementById('certificationSelect');
                
                // Update certifications display list in the Certifications Tab
                allCertificationsDisplay.innerHTML = ''; 
                certificationSelectDropdown.innerHTML = '<option value="">Select Certification</option>';
                
                allCerts.forEach(cert => {
                    // Add to select dropdown in Product Form
                    const option = document.createElement('option');
                    option.value = cert.id;
                    option.textContent = cert.name;
                    certificationSelectDropdown.appendChild(option);

                    // Add to certifications display list in Certifications Tab
                    const certCard = document.createElement('div');
                    certCard.className = 'col-md-4 mb-3';
                    certCard.innerHTML = `
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">${cert.name}</h5>
                                <p class="card-text">${cert.description || ''}</p>
                                <button class="btn btn-danger" onclick="deleteCertification(${cert.id})">Delete</button>
                            </div>
                        </div>
                    `;
                    allCertificationsDisplay.appendChild(certCard);
                });
            } catch (error) {
                console.error('Error loading certifications:', error);
                alert('Error loading certifications: ' + error.message);
            }
        }

        // Feature management
        function addFeature() {
            const featureInput = document.getElementById('featureInput');
            const feature = featureInput.value.trim();
            if (feature) {
                features.push(feature);
                updateFeaturesList();
                featureInput.value = '';
            }
        }

        function removeFeature(index) {
            features.splice(index, 1);
            updateFeaturesList();
        }

        function updateFeaturesList() {
            const featuresList = document.getElementById('featuresList');
            featuresList.innerHTML = features.map((feature, index) => `
                <div class="feature-item">
                    <span>${feature}</span>
                    <button class="btn btn-sm btn-danger" onclick="removeFeature(${index})">Remove</button>
                </div>
            `).join('');
        }

        // Specification management
        function addSpecification() {
            const specName = document.getElementById('specNameInput').value.trim();
            const specValue = document.getElementById('specValueInput').value.trim();
            if (specName && specValue) {
                specifications.push({ name: specName, value: specValue });
                updateSpecificationsList();
                document.getElementById('specNameInput').value = '';
                document.getElementById('specValueInput').value = '';
            }
        }

        function removeSpecification(index) {
            specifications.splice(index, 1);
            updateSpecificationsList();
        }

        function updateSpecificationsList() {
            const specificationsList = document.getElementById('specificationsList');
            specificationsList.innerHTML = specifications.map((spec, index) => `
                <div class="spec-item">
                    <span><strong>${spec.name}:</strong> ${spec.value}</span>
                    <button class="btn btn-sm btn-danger" onclick="removeSpecification(${index})">Remove</button>
                </div>
            `).join('');
        }

        // Certification management
        function addCertification() {
            const select = document.getElementById('certificationSelect');
            const certId = select.value;
            const certName = select.options[select.selectedIndex].text;
            if (certId && !certifications.some(cert => cert.id === certId)) {
                certifications.push({ id: certId, name: certName });
                updateCertificationsList();
            }
        }

        function removeCertification(index) {
            certifications.splice(index, 1);
            updateCertificationsList();
        }

        function updateCertificationsList() {
            const selectedProductCertList = document.getElementById('selectedProductCertificationsList');
            selectedProductCertList.innerHTML = certifications.map((cert, index) => {
                return `
                    <div class="cert-item">
                        <span>${cert.name}</span>
                        <button class="btn btn-sm btn-danger" onclick="removeCertification(${index})">Remove</button>
                    </div>
                `;
            }).join('');
        }

        // Weight Options management
        function addWeightOption() {
            const weightValue = document.getElementById('weightValueInput').value.trim();
            const price = document.getElementById('weightPriceInput').value.trim();
            const packagingPhoto = document.getElementById('packagingPhotoInput').files[0];
            
            if (weightValue && price) {
                weightOptions.push({
                    weightValue: parseInt(weightValue),
                    price: parseFloat(price),
                    packagingPhoto: packagingPhoto
                });
                updateWeightOptionsList();
                document.getElementById('weightValueInput').value = '';
                document.getElementById('weightPriceInput').value = '';
                document.getElementById('packagingPhotoInput').value = '';
            }
        }

        function removeWeightOption(index) {
            weightOptions.splice(index, 1);
            updateWeightOptionsList();
        }

        function updateWeightOptionsList() {
            const weightOptionsList = document.getElementById('weightOptionsList');
            weightOptionsList.innerHTML = weightOptions.map((option, index) => `
                <div class="weight-option-item">
                    <span><strong>${option.weightValue}g:</strong> $${option.price} ${option.packagingPhoto ? '(with packaging photo)' : ''}</span>
                    <button class="btn btn-sm btn-danger" onclick="removeWeightOption(${index})">Remove</button>
                </div>
            `).join('');
        }

        // Toggle nutritional info form
        function toggleNutritionalInfoForm() {
            const hasNutritionalInfoCheckbox = document.getElementById('hasNutritionalInfo');
            const nutritionalInfoForm = document.getElementById('nutritionalInfoForm');
            
            hasNutritionalInfo = hasNutritionalInfoCheckbox.checked;
            nutritionalInfoForm.style.display = hasNutritionalInfo ? 'block' : 'none';
        }

        // Reset the product form to its initial state
        function resetProductForm() {
            document.getElementById('productForm').reset();
            features = [];
            specifications = [];
            certifications = [];
            weightOptions = [];
            hasNutritionalInfo = false;
            editingProductId = null;
            
            updateFeaturesList();
            updateSpecificationsList();
            updateCertificationsList();
            updateWeightOptionsList();
            
            document.getElementById('nutritionalInfoForm').style.display = 'none';
            document.getElementById('hasNutritionalInfo').checked = false;
            
            // Reset form title and button text
            document.querySelector('#productForm').parentNode.querySelector('.card-title').textContent = 'Add New Product';
            document.getElementById('submitProductBtn').textContent = 'Add Product';
            document.getElementById('cancelEditBtn').style.display = 'none';
            
            // Clear file inputs explicitly as reset() might not clear them
            document.getElementById('productImage').value = '';
            document.getElementById('packagingPhotoInput').value = '';
        }

        // Populate form for editing
        async function startEditProduct(productId) {
            console.log(`Starting edit for product ID: ${productId}`);
            resetProductForm(); // Clear form before populating
            editingProductId = productId;

            try {
                // Use fetchWithAuth for all detail fetches
                const [productResponse, featuresResponse, specificationsResponse, 
                       certificationsResponse, nutritionalInfoResponse, weightOptionsResponse] = await Promise.all([
                    fetchWithAuth(`${API_URL}/products/admin/${productId}`), // Fetch product DTO for admin
                    fetchWithAuth(`${API_URL}/products/${productId}/features`),
                    fetchWithAuth(`${API_URL}/products/${productId}/specifications`),
                    fetchWithAuth(`${API_URL}/products/${productId}/certifications`),
                    fetchWithAuth(`${API_URL}/products/${productId}/nutritional-info`),
                    fetchWithAuth(`${API_URL}/products/${productId}/weight-options`)
                ]);

                if (!productResponse.ok) throw new Error('Failed to fetch product details');
                const product = await productResponse.json();

                // Populate basic form fields
                document.getElementById('name').value = product.name;
                document.getElementById('description').value = product.description || '';
                document.getElementById('categoryId').value = product.category ? product.category.id : ''; // Assuming product has category object with id
                document.getElementById('pricePerKg').value = product.pricePerKg;
                document.getElementById('inventory').value = product.inventory;
                document.getElementById('isNewArrival').checked = product.isNewArrival;
                document.getElementById('isBestSeller').checked = product.isBestSeller;
                document.getElementById('hasDiscount').checked = product.hasDiscount;
                document.getElementById('discountPercentage').value = product.discountPercentage || '';

                // Populate features
                if (featuresResponse.ok) {
                    const fetchedFeatures = await featuresResponse.json();
                    features = fetchedFeatures.map(f => f.feature); // Store just the feature strings
                    updateFeaturesList();
                }

                // Populate specifications
                if (specificationsResponse.ok) {
                    const fetchedSpecs = await specificationsResponse.json();
                    specifications = fetchedSpecs.map(s => ({ name: s.specName, value: s.specValue })); // Store as objects
                    updateSpecificationsList();
                }
                
                // Populate certifications
                if (certificationsResponse.ok) {
                    const fetchedCerts = await certificationsResponse.json();
                    certifications = fetchedCerts.map(c => ({ id: c.id, name: c.name })); // Store id and name
                    updateCertificationsList();
                }

                // Populate weight options (NOTE: Editing existing photos needs careful handling, this setup just loads text data)
                if (weightOptionsResponse.ok) {
                    const fetchedWeights = await weightOptionsResponse.json();
                    // We store the photo reference from fetch, but don't re-populate the file input for security reasons.
                    // Editing weight options might require a more complex UI or approach if photos need changing.
                    weightOptions = fetchedWeights.map(w => ({
                        id: w.id, // Assuming weight options have IDs for updates
                        weightValue: w.weightValue,
                        price: w.price,
                        packagingPhotoUrl: w.packagingPhoto // Keep track of existing photo URL
                        // packagingPhoto: undefined // File input cannot be pre-filled
                    }));
                    updateWeightOptionsList(); // Update UI list (without showing file selection)
                }

                // Populate nutritional info
                if (nutritionalInfoResponse.ok) {
                    const fetchedNutritionalInfo = await nutritionalInfoResponse.json();
                    if (fetchedNutritionalInfo) {
                        hasNutritionalInfo = true;
                        document.getElementById('hasNutritionalInfo').checked = true;
                        toggleNutritionalInfoForm(); // Show the form
                        
                        document.getElementById('servingSize').value = fetchedNutritionalInfo.servingSize || '';
                        document.getElementById('servingsPerContainer').value = fetchedNutritionalInfo.servingsPerContainer || '';
                        document.getElementById('calories').value = fetchedNutritionalInfo.calories || '';
                        document.getElementById('totalFat').value = fetchedNutritionalInfo.totalFat || '';
                        document.getElementById('saturatedFat').value = fetchedNutritionalInfo.saturatedFat || '';
                        document.getElementById('transFat').value = fetchedNutritionalInfo.transFat || '';
                        document.getElementById('cholesterol').value = fetchedNutritionalInfo.cholesterol || '';
                        document.getElementById('sodium').value = fetchedNutritionalInfo.sodium || '';
                        document.getElementById('totalCarbohydrates').value = fetchedNutritionalInfo.totalCarbohydrates || '';
                        document.getElementById('dietaryFiber').value = fetchedNutritionalInfo.dietaryFiber || '';
                        document.getElementById('sugars').value = fetchedNutritionalInfo.sugars || '';
                        document.getElementById('protein').value = fetchedNutritionalInfo.protein || '';
                        document.getElementById('vitaminA').value = fetchedNutritionalInfo.vitaminA || '';
                        document.getElementById('vitaminC').value = fetchedNutritionalInfo.vitaminC || '';
                        document.getElementById('calcium').value = fetchedNutritionalInfo.calcium || '';
                        document.getElementById('iron').value = fetchedNutritionalInfo.iron || '';
                    }
                } else {
                     document.getElementById('hasNutritionalInfo').checked = false;
                     toggleNutritionalInfoForm(); // Ensure form is hidden if no data
                }


                // Change form title and button
                document.querySelector('#productForm').parentNode.querySelector('.card-title').textContent = 'Edit Product';
                document.getElementById('submitProductBtn').textContent = 'Update Product';
                document.getElementById('cancelEditBtn').style.display = 'inline-block';

                // Scroll to the form
                 document.getElementById('productForm').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error(`Error fetching details for product ${productId}:`, error);
                alert('Error loading product details for editing: ' + error.message);
                resetProductForm(); // Reset form on error
            }
        }

        // Add new product
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // --- Gather Data --- 
            const name = document.getElementById('name').value;
            const description = document.getElementById('description').value;
            const categoryId = document.getElementById('categoryId').value;
            const pricePerKg = document.getElementById('pricePerKg').value;
            const inventory = document.getElementById('inventory').value;
            const isNewArrival = document.getElementById('isNewArrival').checked;
            const isBestSeller = document.getElementById('isBestSeller').checked;
            const hasDiscount = document.getElementById('hasDiscount').checked;
            const discountPercentage = document.getElementById('discountPercentage').value || '0';
            const productImageFile = document.getElementById('productImage').files[0];

            // Gather features (array of strings)
            const currentFeatures = features; // features array holds strings

            // Gather specifications (array of {specName: string, specValue: string})
            const currentSpecifications = specifications.map(s => ({ specName: s.name, specValue: s.value }));

            // Gather certifications (array of numbers/longs - the IDs)
            const currentCertificationIds = certifications.map(c => parseInt(c.id));

            // Gather weight options (array of {weightValue: string, price: number, packagingPhoto: string/url})
            // Note: Backend expects weightValue as String, price as BigDecimal (number ok), packagingPhoto as String URL
            // We need to handle existing options (with IDs/URLs) vs newly added ones (no ID/URL yet)
            // This simplistic approach just sends the current state, potentially losing existing IDs/URLs if not handled carefully in startEditProduct
            const currentWeightOptions = weightOptions.map(wo => ({
                id: wo.id, // Send ID if editing an existing option
                weightValue: String(wo.weightValue), // Convert to string
                price: wo.price,
                // Send existing URL if available, otherwise null. Don't send the File object.
                packagingPhoto: wo.packagingPhotoUrl || null 
                // NOTE: New photos for new/existing options need separate handling (e.g., dedicated endpoint per option)
            }));

            // Gather nutritional info (object or null)
            let currentNutritionalInfo = null;
            if (hasNutritionalInfo) {
                currentNutritionalInfo = {
                    servingSize: document.getElementById('servingSize').value || null,
                    servingsPerContainer: document.getElementById('servingsPerContainer').value || null,
                    calories: document.getElementById('calories').value || null,
                    totalFat: document.getElementById('totalFat').value || null,
                    saturatedFat: document.getElementById('saturatedFat').value || null,
                    transFat: document.getElementById('transFat').value || null,
                    cholesterol: document.getElementById('cholesterol').value || null,
                    sodium: document.getElementById('sodium').value || null,
                    totalCarbohydrates: document.getElementById('totalCarbohydrates').value || null,
                    dietaryFiber: document.getElementById('dietaryFiber').value || null,
                    sugars: document.getElementById('sugars').value || null,
                    protein: document.getElementById('protein').value || null,
                    vitaminA: document.getElementById('vitaminA').value || null,
                    vitaminC: document.getElementById('vitaminC').value || null,
                    calcium: document.getElementById('calcium').value || null,
                    iron: document.getElementById('iron').value || null,
                    // Match DTO field names used in backend convertToProductDTO/updateProductDetails
                    fat: document.getElementById('totalFat').value || null, // Assuming DTO uses 'fat'
                    carbohydrates: document.getElementById('totalCarbohydrates').value || null, // Assuming DTO uses 'carbohydrates'
                    fiber: document.getElementById('dietaryFiber').value || null, // Assuming DTO uses 'fiber'
                    sugar: document.getElementById('sugars').value || null // Assuming DTO uses 'sugar'
                };
            }


            try {
                let response;
                let method;
                let url;
                let body;
                let headers = {};
                let successMessage;

                if (editingProductId) {
                    // --- Prepare for PUT (Update) ---
                    method = 'PUT';
                    url = `${API_URL}/products/${editingProductId}`;
                    successMessage = 'Product updated successfully!';
                    headers['Content-Type'] = 'application/json';

                    const productDTO = {
                        name: name,
                        description: description,
                        // imageUrl: null, // Don't update image via DTO for now
                        categoryId: categoryId ? parseInt(categoryId) : null,
                        isNewArrival: isNewArrival,
                        isBestSeller: isBestSeller,
                        pricePerKg: parseFloat(pricePerKg),
                        hasDiscount: hasDiscount,
                        discountPercentage: hasDiscount ? parseInt(discountPercentage) : 0,
                        inventory: parseInt(inventory),
                        certificationIds: currentCertificationIds,
                        features: currentFeatures,
                        specifications: currentSpecifications,
                        nutritionalInfo: currentNutritionalInfo,
                        weightOptions: currentWeightOptions
                    };
                    body = JSON.stringify(productDTO);
                    
                    // TODO: Handle image update separately if productImageFile exists
                    if (productImageFile) {
                        console.warn("Image file selected during edit, but image update via this PUT is not implemented yet.");
                        // Potential future: call a separate image upload endpoint here
                        // e.g., await uploadProductImage(editingProductId, productImageFile);
                    }
                    
                    // TODO: Handle new/updated weight option photos separately if needed
                    // This requires checking `weightOptions` array for File objects and calling separate endpoints.

                } else {
                    // --- Prepare for POST (Create) ---
                    method = 'POST';
                    url = `${API_URL}/products`;
                    successMessage = 'Product added successfully!';
                    // Use FormData for POST to include the image
                    const formData = new FormData();
                    formData.append('name', name);
                    formData.append('description', description);
                    if (categoryId) formData.append('categoryId', categoryId);
                    formData.append('pricePerKg', pricePerKg);
                    formData.append('inventory', inventory);
                    formData.append('isNewArrival', isNewArrival);
                    formData.append('isBestSeller', isBestSeller);
                    formData.append('hasDiscount', hasDiscount);
                    formData.append('discountPercentage', discountPercentage);
                    if (productImageFile) {
                         formData.append('image', productImageFile);
                    }
                    body = formData;
                    // Let browser set Content-Type for FormData
                    delete headers['Content-Type']; 
                    
                    // NOTE: The initial POST endpoint /api/products only saves the core product fields and image.
                    // Related entities (features, specs, etc.) are added via separate POST calls AFTER the product is created.
                }

                // Use fetchWithAuth for product creation or update
                response = await fetchWithAuth(url, {
                    method: method,
                    headers: headers, // Pass headers (esp. Content-Type for PUT)
                    body: body 
                });
                
                if (!response.ok) {
                    const errorData = await response.text(); // Read error as text
                    console.error('Server Response Error:', errorData);
                    try {
                        const parsedError = JSON.parse(errorData); 
                        throw new Error(parsedError.message || JSON.stringify(parsedError));
                    } catch (parseError) {
                        throw new Error(errorData || `HTTP error! status: ${response.status}`);
                    }
                }
                
                const savedOrUpdatedProduct = await response.json();
                const productIdToUpdate = editingProductId || savedOrUpdatedProduct.id;

                // --- Logic for Adding/Updating Related Entities ---
                // This is complex and differs between POST (Create) and PUT (Update)

                if (method === 'POST') {
                    // POST (Create): Saved core product, now add related entities via separate calls
                    console.log("Adding related entities for new product:", productIdToUpdate);
                    
                    // Add features
                    for (const feature of currentFeatures) {
                        await fetchWithAuth(`${API_URL}/products/${productIdToUpdate}/features`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, 
                            body: `feature=${encodeURIComponent(feature)}`
                        });
                    }
                    
                    // Add specifications
                    for (const spec of currentSpecifications) {
                        await fetchWithAuth(`${API_URL}/products/${productIdToUpdate}/specifications`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, 
                            body: `specName=${encodeURIComponent(spec.specName)}&specValue=${encodeURIComponent(spec.specValue)}`
                        });
                    }

                    // Add certifications
                    for (const certId of currentCertificationIds) {
                        await fetchWithAuth(`${API_URL}/products/${productIdToUpdate}/certifications/${certId}`, {
                            method: 'POST'
                        });
                    }

                    // Add weight options (handle packaging photo upload)
                    for (const option of weightOptions) { // Use original weightOptions array which might contain File objects
                       const weightOptionFormData = new FormData();
                       weightOptionFormData.append('weightValue', option.weightValue);
                       weightOptionFormData.append('price', option.price);
                       if (option.packagingPhoto instanceof File) {
                           weightOptionFormData.append('packagingImage', option.packagingPhoto);
                       }
                       
                       const optionResponse = await fetchWithAuth(`${API_URL}/products/${productIdToUpdate}/weight-options`, {
                           method: 'POST',
                           body: weightOptionFormData
                       });
                       if (!optionResponse.ok) console.error('Failed to save new weight option');
                    }

                    // Add nutritional info if specified
                    if (currentNutritionalInfo) {
                         const nutritionalInfoResponse = await fetchWithAuth(`${API_URL}/products/${productIdToUpdate}/nutritional-info`, {
                            method: 'POST',
                            body: JSON.stringify(currentNutritionalInfo)
                        });
                        if (!nutritionalInfoResponse.ok) {
                            const errorData = await nutritionalInfoResponse.text();
                            console.error('Failed to save nutritional info:', errorData);
                            throw new Error('Failed to save nutritional information');
                        }
                    }
                    
                } else { // PUT (Update)
                    // PUT: Backend's updateProductDetails handles related entities based on DTO.
                    // However, we might need separate calls for things not handled by the DTO update,
                    // like NEW weight option photos or deleting weight options that were removed in the UI.
                    console.log("Product updated via PUT with DTO. Checking for additional actions needed.");
                    
                    // Example: Handling newly added photos for *existing* weight options
                    // This requires more complex logic: iterate through `weightOptions` array,
                    // find items with an `id` AND a `packagingPhoto` File object, then call a specific endpoint.
                    // e.g., PUT /api/weight-options/{id}/image with the file.
                    
                    // Example: Handling deletion of weight options removed from the UI list.
                    // Compare `initialWeightOptionIds` (need to store this when starting edit) 
                    // with `currentWeightOptions.map(wo => wo.id)`. IDs present initially but not 
                    // currently need to be deleted via DELETE /api/weight-options/{id}.
                    
                    console.warn("Weight option photo updates/deletions during edit are not fully implemented yet.");
                }

                // Reset form and arrays only on success
                resetProductForm(); 
                loadProducts(); // Reload the product list
                alert(successMessage); 

            } catch (error) {
                console.error(`Error ${editingProductId ? 'updating' : 'adding'} product:`, error);
                alert(`Error ${editingProductId ? 'updating' : 'adding'} product: ${error.message}`);
            }
        });

        // Add new category
        document.getElementById('categoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const categoryData = {
                name: document.getElementById('categoryName').value,
                description: document.getElementById('categoryDescription').value
            };

            try {
                // Use fetchWithAuth
                await fetchWithAuth(`${API_URL}/categories`, {
                    method: 'POST',
                    // fetchWithAuth sets Content-Type
                    body: JSON.stringify(categoryData)
                });
                document.getElementById('categoryForm').reset();
                loadCategories();
            } catch (error) {
                console.error('Error adding category:', error);
            }
        });

        // Delete product
        async function deleteProduct(id) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    // Use fetchWithAuth
                    const response = await fetchWithAuth(`${API_URL}/products/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to delete product');
                    }
                    
                    // Show success message
                    alert('Product deleted successfully');
                    
                    // Reload the products list
                    await loadProducts();
                } catch (error) {
                    console.error('Error deleting product:', error);
                    alert('Error deleting product: ' + error.message);
                }
            }
        }

        // Delete category
        async function deleteCategory(id) {
            if (confirm('Are you sure you want to delete this category?')) {
                try {
                    // Use fetchWithAuth
                    const response = await fetchWithAuth(`${API_URL}/categories/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to delete category');
                    }
                    
                    // Show success message
                    alert('Category deleted successfully');
                    
                    // Reload the categories list
                    await loadCategories();
                } catch (error) {
                    console.error('Error deleting category:', error);
                    alert('Error deleting category: ' + error.message);
                }
            }
        }

        // Delete certification
        async function deleteCertification(id) {
            if (confirm('Are you sure you want to delete this certification?')) {
                try {
                    // Use fetchWithAuth
                    const response = await fetchWithAuth(`${API_URL}/certifications/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Failed to delete certification');
                    }
                    
                    // Show success message
                    alert('Certification deleted successfully');
                    
                    // Reload the certifications list
                    await loadCertifications();
                } catch (error) {
                    console.error('Error deleting certification:', error);
                    alert('Error deleting certification: ' + error.message);
                }
            }
        }

        // Add new certification
        document.getElementById('certificationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const certificationData = {
                name: document.getElementById('certificationName').value,
                description: document.getElementById('certificationDescription').value
            };

            try {
                // Use fetchWithAuth
                await fetchWithAuth(`${API_URL}/certifications`, {
                    method: 'POST',
                    // fetchWithAuth sets Content-Type
                    body: JSON.stringify(certificationData)
                });
                document.getElementById('certificationForm').reset();
                loadCertifications();
            } catch (error) {
                console.error('Error adding certification:', error);
            }
        });

        // Load initial data
        loadProducts();
        loadCategories();
        loadCertifications();
    </script>
</body>
</html> 